# codemagic.yaml
workflows:
  appstore-release:
    name: iOS App Store Release
    environment:
      xcode: latest
      groups:
        - appstore_signing  # 生产证书组
      vars:
        BUNDLE_ID: "com.test.ios.attaf"  # 替换为您的 Bundle ID
        SCHEME: "123"  # 替换为您的 Scheme
    
    # iOS 自动代码签名配置 - 使用生产证书
    ios:
      project: "123.xcodeproj"  # 或者 YourApp.xcworkspace
      scheme: "$123"
      configuration: "Release"
      # 代码签名配置
      signing:
        certificate_url: $APPSTORE_CERTIFICATE_URL
        certificate_password: $APPSTORE_CERTIFICATE_PASSWORD
        provisioning_profile_url: $APPSTORE_PROVISIONING_PROFILE_URL
    
    # 构建脚本
    scripts:
      - name: Set up environment
        script: |
          # 设置版本号
          if [ ! -z "$BUILD_NUMBER" ]; then
            agvtool new-version -all $BUILD_NUMBER
          fi
      
      - name: Install dependencies
        script: |
          # 安装 CocoaPods 依赖
          pod install --repo-update
      
      - name: Build and archive
        script: |
          # 构建归档
          xcodebuild archive \
            -workspace "YourApp.xcworkspace" \
            -scheme "$SCHEME" \
            -configuration Release \
            -archivePath "build/YourApp.xcarchive" \
            -destination 'generic/platform=iOS'
      
      - name: Export IPA
        script: |
          # 创建 exportOptions.plist 文件
          cat > exportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
              <key>teamID</key>
              <string>$TEAM_ID</string>
              <key>uploadBitcode</key>
              <false/>
              <key>compileBitcode</key>
              <false/>
          </dict>
          </plist>
          EOF
          
          # 导出 IPA
          xcodebuild -exportArchive \
            -archivePath "build/YourApp.xcarchive" \
            -exportPath "build" \
            -exportOptionsPlist "exportOptions.plist"
    
    # 产物
    artifacts:
      - build/*.ipa
      - build/*.dSYM.zip
    
    # 发布到 App Store Connect
    publishing:
      app_store_connect:
        api_key: $APP_STORE_CONNECT_API_KEY
        key_id: $APP_STORE_CONNECT_KEY_IDENTIFIER
        issuer_id: $APP_STORE_CONNECT_ISSUER_ID
        submit_to_testflight: true
