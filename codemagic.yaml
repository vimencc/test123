workflows:
  ios-release:
    name: iOS App Store Release
    max_build_duration: 120
    instance_type: mac_mini_m2
    environment:
      xcode: latest
      groups:
        # 只保留 appstore_connect 组
        - appstore_connect
      vars:
        # 基础配置
        APP_IDENTIFIER: "com.test.ios.attaf"
        APPLE_ID: "lingya00130@gmail.com"
        TEAM_ID: "7994453ZHZ"
        XCODE_SCHEME: "123"
        XCODE_WORKSPACE: "123.xcworkspace"
        
        # 代码签名配置（硬编码或从其他方式获取）
        CODE_SIGNING_IDENTITY: "Apple Distribution"
        PROVISIONING_PROFILE_NAME: "codemagic_Production"
    
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: 'main'
          include: true
        - pattern: 'release/*'
          include: true
      cancel_previous_builds: false
    
    cache:
      cache_paths:
        - ~/Library/Caches/CocoaPods
        - ~/Library/Developer/Xcode/DerivedData
        - vendor/bundle
    
    scripts:
      # 1. 安装依赖
      - name: Install dependencies
        script: |
          echo "=== 安装依赖 ==="
          echo "当前目录: $(pwd)"
          echo "目录内容:"
          ls -la
          
          # 检查项目结构
          if [ -f "Podfile" ]; then
            echo "安装CocoaPods依赖..."
            pod install
          else
            echo "未找到Podfile"
          fi
          
          # 安装fastlane
          sudo gem install fastlane -NV
          
          # 创建必要目录
          mkdir -p build
          mkdir -p fastlane
          
          echo "✅ 依赖安装完成"
      
      # 2. 准备代码签名
      - name: Prepare code signing
        script: |
          echo "=== 准备代码签名 ==="
          echo "使用Codemagic UI配置的代码签名"
          echo "团队ID: $TEAM_ID"
          echo "应用标识符: $APP_IDENTIFIER"
          
          # 显示可用的证书
          echo "系统钥匙串中的证书:"
          security find-identity -p codesigning -v
          
          # 创建export_options.plist
          cat > export_options.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
              <key>teamID</key>
              <string>$TEAM_ID</string>
              <key>uploadBitcode</key>
              <false/>
              <key>compileBitcode</key>
              <false/>
              <key>provisioningProfiles</key>
              <dict>
                  <key>$APP_IDENTIFIER</key>
                  <string>$PROVISIONING_PROFILE_NAME</string>
              </dict>
          </dict>
          </plist>
          EOF
          
          echo "✅ 代码签名准备完成"
      
      # 3. 使用Codemagic内置工具构建
      - name: Build with Codemagic tools
        script: |
          echo "=== 使用Codemagic工具构建 ==="
          
          # 检查项目文件
          if [ -n "$XCODE_WORKSPACE" ] && [ -f "$XCODE_WORKSPACE" ]; then
            echo "使用workspace: $XCODE_WORKSPACE"
            PROJECT_ARG="--workspace $XCODE_WORKSPACE"
          elif [ -n "$XCODE_PROJECT" ] && [ -f "$XCODE_PROJECT" ]; then
            echo "使用project: $XCODE_PROJECT"
            PROJECT_ARG="--project $XCODE_PROJECT"
          else
            echo "❌ 未找到Xcode项目文件"
            echo "当前目录内容:"
            ls -la
            exit 1
          fi
          
          # 使用Codemagic工具构建
          echo "开始构建..."
          
          # 应用代码签名配置文件
          xcode-project use-profiles
          
          # 构建命令
          xcode-project build-ipa \
            $PROJECT_ARG \
            --scheme "$XCODE_SCHEME" \
            --output "build" \
            --archive-flags "-destination 'generic/platform=iOS' -allowProvisioningUpdates" \
            --export-options-plist "export_options.plist"
          
          echo "✅ 构建命令执行完成"
      
      # 4. 备用构建方案（使用fastlane）
      - name: Build with fastlane (fallback)
        script: |
          echo "=== 尝试备用构建方案 ==="
          
          # 检查是否已经有IPA文件
          if [ -f "build/$XCODE_SCHEME.ipa" ]; then
            echo "✅ 已有IPA文件，跳过备用构建"
            exit 0
          fi
          
          echo "主构建失败，尝试fastlane构建..."
          
          # 创建fastlane配置
          cat > fastlane/Fastfile << EOF
          default_platform(:ios)
          
          platform :ios do
            lane :build do
              gym(
                workspace: "$XCODE_WORKSPACE",
                scheme: "$XCODE_SCHEME",
                configuration: "Release",
                output_directory: "../build",
                output_name: "$XCODE_SCHEME.ipa",
                export_method: "app-store",
                export_options: {
                  provisioningProfiles: {
                    "$APP_IDENTIFIER" => "$PROVISIONING_PROFILE_NAME"
                  },
                  teamID: "$TEAM_ID"
                },
                clean: true
              )
            end
          end
          EOF
          
          # 运行fastlane构建
          cd fastlane
          fastlane ios build
          cd ..
          
          echo "✅ Fastlane构建完成"
      
      # 5. 验证构建产物
      - name: Verify artifacts
        script: |
          echo "=== 验证构建产物 ==="
          
          # 查找IPA文件
          echo "搜索IPA文件..."
          find . -name "*.ipa" -type f 2>/dev/null | head -5 || echo "未找到IPA文件"
          
          # 检查预期的IPA
          EXPECTED_IPA="build/$XCODE_SCHEME.ipa"
          if [ -f "$EXPECTED_IPA" ]; then
            echo "✅ 找到IPA文件: $EXPECTED_IPA"
            echo "文件大小: $(du -h "$EXPECTED_IPA" | cut -f1)"
            
            # 显示基本信息
            echo "文件类型:"
            file "$EXPECTED_IPA"
          else
            echo "❌ 未在预期路径找到IPA: $EXPECTED_IPA"
            echo "build目录内容:"
            ls -la build/ 2>/dev/null || echo "build目录不存在"
            exit 1
          fi
    
    artifacts:
      - build/*.ipa
      - export_options.plist
    
    publishing:
      # 邮件通知
      email:
        recipients:
          - "lingya00130@gmail.com"
        notify:
          success: true
          failure: true
      
      # 发布到App Store Connect
      app_store_connect:
        api_key: $APP_STORE_CONNECT_API_KEY
        key_id: $APP_STORE_CONNECT_KEY_IDENTIFIER
        issuer_id: $APP_STORE_CONNECT_ISSUER_ID
        submit_to_testflight: true
        submit_to_app_store: false
        beta_groups:
          - "Internal Testers"
