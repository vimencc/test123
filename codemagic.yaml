workflows:
  ios-release:
    name: iOS App Store Release
    max_build_duration: 120
    instance_type: mac_mini_m2
    environment:
      xcode: latest
      groups:
        - appstore_connect
      vars:
        # 基础配置
        APP_IDENTIFIER: "com.test.ios.attaf"
        APPLE_ID: "lingya00130@gmail.com"
        TEAM_ID: "7994453ZHZ"
        XCODE_SCHEME: "123"
    
    triggering:
      events:
        - push
      branch_patterns:
        - pattern: 'main'
          include: true
        - pattern: 'release/*'
          include: true
      cancel_previous_builds: false
    
    cache:
      cache_paths:
        - ~/Library/Caches/CocoaPods
        - ~/Library/Developer/Xcode/DerivedData
    
    scripts:
      # 1. 设置环境
      - name: Setup environment
        script: |
          echo "=== 设置环境 ==="
          echo "当前目录: $(pwd)"
          echo "Xcode版本: $(xcodebuild -version)"
          
          # 显示项目结构
          echo "项目结构:"
          ls -la
          
          # 检查workspace和project
          if [ -d "123.xcworkspace" ]; then
            echo "✅ 使用workspace: 123.xcworkspace"
          elif [ -d "123.xcodeproj" ]; then
            echo "✅ 使用project: 123.xcodeproj"
          else
            echo "❌ 未找到项目文件"
            exit 1
          fi
          
          # 检查scheme
          echo "检查scheme..."
          if [ -d "123.xcworkspace" ]; then
            xcodebuild -list -workspace "123.xcworkspace" 2>&1 | grep -A 10 "Schemes:" || echo "无法列出scheme"
          elif [ -d "123.xcodeproj" ]; then
            xcodebuild -list -project "123.xcodeproj" 2>&1 | grep -A 10 "Schemes:" || echo "无法列出scheme"
          fi
      
      # 2. 安装依赖（如果需要）
      - name: Install dependencies
        script: |
          echo "=== 安装依赖 ==="
          
          if [ -f "Podfile" ]; then
            echo "安装CocoaPods依赖..."
            pod install
          else
            echo "没有Podfile，跳过CocoaPods安装"
          fi
          
          # 创建构建目录
          mkdir -p build
      
      # 3. 准备代码签名（使用Codemagic自动配置）
      - name: Prepare code signing
        script: |
          echo "=== 准备代码签名 ==="
          echo "团队ID: $TEAM_ID"
          echo "应用标识符: $APP_IDENTIFIER"
          
          # 显示可用证书
          echo "可用证书:"
          security find-identity -p codesigning -v | grep -i "distribution" || true
          
          # 使用Codemagic自动配置代码签名
          echo "应用Codemagic代码签名配置..."
          xcode-project use-profiles
      
      # 4. 使用最简化的构建方法
      - name: Simple build and export
        script: |
          echo "=== 简化的构建和导出 ==="
          
          # 清理build目录
          rm -rf build/*
          
          # 确定使用workspace还是project
          if [ -d "123.xcworkspace" ]; then
            echo "使用workspace构建..."
            
            # 1. 构建archive
            echo "步骤1: 构建archive..."
            xcodebuild archive \
              -workspace "123.xcworkspace" \
              -scheme "$XCODE_SCHEME" \
              -configuration Release \
              -archivePath "build/$XCODE_SCHEME.xcarchive" \
              -destination 'generic/platform=iOS' \
              -allowProvisioningUpdates \
              2>&1 | tee build/archive.log
            
            # 检查archive是否成功
            if [ ! -d "build/$XCODE_SCHEME.xcarchive" ]; then
              echo "❌ archive构建失败，查看日志:"
              tail -50 build/archive.log
              exit 1
            fi
            echo "✅ archive构建成功"
            
          elif [ -d "123.xcodeproj" ]; then
            echo "使用project构建..."
            
            # 1. 构建archive
            echo "步骤1: 构建archive..."
            xcodebuild archive \
              -project "123.xcodeproj" \
              -scheme "$XCODE_SCHEME" \
              -configuration Release \
              -archivePath "build/$XCODE_SCHEME.xcarchive" \
              -destination 'generic/platform=iOS' \
              -allowProvisioningUpdates \
              2>&1 | tee build/archive.log
            
            # 检查archive是否成功
            if [ ! -d "build/$XCODE_SCHEME.xcarchive" ]; then
              echo "❌ archive构建失败，查看日志:"
              tail -50 build/archive.log
              exit 1
            fi
            echo "✅ archive构建成功"
          fi
          
          # 2. 导出IPA
          echo "步骤2: 导出IPA..."
          
          # 创建export_options.plist
          cat > build/export_options.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
              <key>teamID</key>
              <string>$TEAM_ID</string>
              <key>uploadBitcode</key>
              <false/>
              <key>compileBitcode</key>
              <false/>
          </dict>
          </plist>
          EOF
          
          # 执行导出
          xcodebuild -exportArchive \
            -archivePath "build/$XCODE_SCHEME.xcarchive" \
            -exportOptionsPlist "build/export_options.plist" \
            -exportPath "build" \
            -allowProvisioningUpdates \
            2>&1 | tee build/export.log
          
          echo "✅ 导出完成"
      
      # 5. 检查并重命名IPA文件
      - name: Verify and rename IPA
        script: |
          echo "=== 验证和重命名IPA文件 ==="
          
          # 查找生成的IPA文件
          echo "查找IPA文件..."
          IPA_FILES=$(find build -name "*.ipa" 2>/dev/null)
          
          if [ -z "$IPA_FILES" ]; then
            echo "❌ 未找到IPA文件"
            echo "导出日志最后50行:"
            tail -50 build/export.log || echo "无导出日志"
            exit 1
          fi
          
          echo "找到的IPA文件:"
          echo "$IPA_FILES"
          
          # 如果IPA文件不在根目录，移动到根目录
          if [ ! -f "build/$XCODE_SCHEME.ipa" ]; then
            FIRST_IPA=$(echo "$IPA_FILES" | head -1)
            echo "将IPA文件复制到标准位置: $FIRST_IPA -> build/$XCODE_SCHEME.ipa"
            cp "$FIRST_IPA" "build/$XCODE_SCHEME.ipa"
          fi
          
          # 验证IPA文件
          if [ -f "build/$XCODE_SCHEME.ipa" ]; then
            echo "✅ IPA文件创建成功: build/$XCODE_SCHEME.ipa"
            echo "文件大小: $(du -h "build/$XCODE_SCHEME.ipa" | cut -f1)"
            
            # 显示文件信息
            echo "文件信息:"
            ls -la "build/$XCODE_SCHEME.ipa"
          else
            echo "❌ IPA文件未创建"
            exit 1
          fi
      
      # 6. 显示构建摘要
      - name: Build summary
        script: |
          echo "=== 构建摘要 ==="
          echo "✅ 构建成功!"
          echo ""
          echo "生成的产物:"
          ls -la build/*.ipa 2>/dev/null || echo "无IPA文件"
          ls -la build/*.xcarchive 2>/dev/null || echo "无xcarchive文件"
          echo ""
          echo "构建目录内容:"
          ls -la build/
    
    artifacts:
      - build/*.ipa
      - build/*.xcarchive
      - build/export_options.plist
      - build/archive.log
      - build/export.log
    
    publishing:
      # 邮件通知
      email:
        recipients:
          - "717@stlnd.net"
        notify:
          success: true
          failure: true
      
      # 发布到App Store Connect
      app_store_connect:
        api_key: $APP_STORE_CONNECT_API_KEY
        key_id: $APP_STORE_CONNECT_KEY_IDENTIFIER
        issuer_id: $APP_STORE_CONNECT_ISSUER_ID
        submit_to_testflight: true
        submit_to_app_store: false
        beta_groups:
          - "Internal Testers"
